{% extends "layout.html" %}

{% block title %}Sales - Pharmacy App{% endblock %}

{% block content %}
<h2>Sales</h2>
<p class="muted">Record sales quickly and monitor todayâ€™s performance.</p>

<div class="card" style="margin-top:0; margin-bottom:14px;">
  <form method="get" style="display:grid; gap:10px;">
    <div>
      <label for="q">Search products in sales and product picker</label><br>
      <input
        id="q"
        name="q"
        value="{{ search_query or '' }}"
        placeholder="Search by product name, code, or category"
      >
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button type="submit">Search</button>
      <a class="btn" href="{{ url_for('sales.sales_home') }}">Clear</a>
    </div>
  </form>
</div>

<div class="grid2">
  <div class="card" style="margin-top:0;">
    <h3>Record New Sale</h3>
    <form method="POST">
      <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">

      <div>
        <label for="product_id">Product</label><br>
        <select id="product_id" name="product_id" required>
          <option value="">-- Select product --</option>
          {% for p in products %}
            <option value="{{ p.id }}">{{ p.name }}{% if p.code %} ({{ p.code }}){% endif %}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="quantity">Quantity</label><br>
        <input type="number" id="quantity" name="quantity" min="1" required>
      </div>

      <button type="submit">Record Sale</button>
    </form>
  </div>

  <div class="card" style="margin-top:0;">
    <h3>Today's Summary</h3>
    <table>
      <tr>
        <th>Total sales entries</th>
        <td><strong>{{ today_sales_count }}</strong></td>
      </tr>
      <tr>
        <th>Items sold</th>
        <td><strong>{{ today_items_sold }}</strong></td>
      </tr>
      <tr>
        <th>Total amount</th>
        <td><strong>{{ "%.2f"|format(today_total_amount) }}</strong></td>
      </tr>
      <tr>
        <th>Total profit</th>
        <td><strong>{{ "%.2f"|format(today_total_profit or 0) }}</strong></td>
      </tr>
    </table>
  </div>
</div>

<div class="card">
  <h3>Recent Sales</h3>
  {% if recent_sales %}
    <table>
      <tr>
        <th>#</th>
        <th>Date/Time</th>
        <th>Product</th>
        <th>Qty</th>
        <th>Cost Price</th>
        <th>Unit Price</th>
        <th>Total</th>
        <th>Profit</th>
        <th>Invoice</th>
      </tr>
      {% for s in recent_sales %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>
          {% if s.created_at %}
            {{ s.created_at.strftime('%Y-%m-%d %H:%M') }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>{{ s.product.name if s.product else "Unknown" }}</td>
        <td>{{ s.quantity }}</td>
        <td>{{ "%.2f"|format(s.buying_price or 0) }}</td>
        <td>{{ "%.2f"|format(s.unit_price or 0) }}</td>
        <td>{{ "%.2f"|format(s.line_total or 0) }}</td>
        <td>{{ "%.2f"|format(s.line_profit or 0) }}</td>
        <td>
          {% set linked_invoice = linked_invoices.get(s.id) %}
          {% if linked_invoice %}
            <a href="{{ url_for('invoices.view_invoice', invoice_id=linked_invoice.id) }}">View {{ linked_invoice.invoice_number }}</a>
          {% else %}
            <form method="post" action="{{ url_for('invoices.create_invoice_from_sale', sale_id=s.id) }}" style="display:inline;">
              <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
              <button type="submit" style="padding:6px 10px;">Create Invoice</button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>
  {% else %}
    <p>No sales yet.</p>
  {% endif %}
</div>

{% endblock %}
