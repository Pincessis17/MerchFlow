{% extends "layout.html" %}

{% block title %}Inventory - Pharmacy App{% endblock %}

{% block content %}
<h2>Inventory</h2>
<p class="muted">Manage stock levels, cost price, and selling price in one place.</p>

<div class="grid2">
  <div class="card" style="margin-top:0;">
    <h3>Add New Product</h3>
    <form method="POST">
      <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">

      <div>
        <label for="name">Product Name</label><br>
        <input type="text" id="name" name="name" required>
      </div>

      <div class="grid2">
        <div>
          <label for="quantity">Quantity</label><br>
          <input type="number" id="quantity" name="quantity" min="0">
        </div>
        <div>
          <label for="unit">Unit (e.g. BTL, TAB, PK)</label><br>
          <input type="text" id="unit" name="unit">
        </div>
      </div>

      <div class="grid2">
        <div>
          <label for="category">Category</label><br>
          <input type="text" id="category" name="category">
        </div>
        <div>
          <label for="expiry_date">Expiry Date</label><br>
          <input type="date" id="expiry_date" name="expiry_date">
        </div>
      </div>

      <div class="grid2">
        <div>
          <label for="buying_price">Cost Price</label><br>
          <input type="number" step="0.01" id="buying_price" name="buying_price" min="0">
        </div>
        <div>
          <label for="price">Selling Price</label><br>
          <input type="number" step="0.01" id="price" name="price" min="0">
        </div>
      </div>

      <button type="submit">Add Product</button>
    </form>
  </div>

  <div class="card" style="margin-top:0;">
    <h3>Inventory Tips</h3>
    <ul>
      <li>Keep cost price updated after each purchase for accurate profit.</li>
      <li>Use expiry date where relevant for safer stock handling.</li>
      <li>Set quantity to zero for out-of-stock products instead of deleting immediately.</li>
    </ul>

    <hr style="border: none; border-top: 1px solid rgba(255,255,255,.12); margin: 16px 0;">

    <h3>Bulk Import (CSV)</h3>
    <p class="muted" style="margin-top:0;">
      Tenant admins/managers can upload inventory directly. The system creates new products
      and updates existing products by <strong>SKU/Code</strong>.
    </p>

    <form
      method="POST"
      action="{{ url_for('inventory.import_products_csv') }}"
      enctype="multipart/form-data"
    >
      <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
      <div>
        <label for="products_csv">Inventory CSV file</label><br>
        <input id="products_csv" name="products_csv" type="file" accept=".csv,text/csv" required>
      </div>
      <button type="submit">Import Inventory CSV</button>
    </form>

    <p class="muted" style="margin-top:10px;">
      Required columns: <code>sku</code> (or <code>code</code>) and <code>name</code>. <br>
      Optional: <code>stock_qty</code>, <code>unit</code>, <code>category</code>, <code>expiry_date</code>,
      <code>cost_price</code>, <code>selling_price</code>.
    </p>
    <a href="{{ url_for('inventory.download_inventory_import_template') }}">
      Download CSV template
    </a>
  </div>
</div>

<div class="card">
  <h3>Current Products</h3>
  {% if products %}
    <table>
      <tr>
        <th>#</th>
        <th>Product Name</th>
        <th>Quantity</th>
        <th>Unit</th>
        <th>Category</th>
        <th>Expiry Date</th>
        <th>Cost Price</th>
        <th>Selling Price</th>
        <th>Actions</th>
      </tr>
      {% for p in products %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ p.name }}</td>
        <td>{{ p.quantity }}</td>
        <td>{{ p.unit or "" }}</td>
        <td>{{ p.category or "" }}</td>
        <td>{{ p.expiry_date or "-" }}</td>
        <td>{{ "%.2f" | format(p.buying_price or 0) }}</td>
        <td>{{ "%.2f" | format(p.price or 0) }}</td>
        <td>
          <a href="{{ url_for('inventory.edit_product', product_id=p.id) }}">Edit</a>
          <form
            method="POST"
            action="{{ url_for('inventory.delete_product', product_id=p.id) }}"
            style="display:inline; margin-left: 8px;"
          >
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
            <button
              type="submit"
              style="padding:4px 8px; border:1px solid rgba(255,107,107,.6); border-radius:8px; background:rgba(255,107,107,.15); color:inherit; cursor:pointer;"
            >
              Delete
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>
  {% else %}
    <p>No products yet. Add one using the form above.</p>
  {% endif %}
</div>
{% endblock %}
