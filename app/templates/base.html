<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{ title or "MerchFlow" }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}">
  </head>

  <body>
    <div class="wrap">

      <!-- ===================== NAVBAR ===================== -->
      <div class="glass navbar">

        <!-- Brand -->
        <div class="brand">
          <img
            src="{{ url_for('static', filename='branding/merchflow-mark.svg') }}"
            alt="MerchFlow logo mark"
            class="brand-mark"
          >
          <div>
            <strong>MerchFlow</strong>
            {% if session.get('user') %}
              <div class="company-name">
                {{ session.get('user').get('company_name', '') }}
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Navigation -->
        <div class="navlinks">
          {% set nav_user = session.get('user', {}) %}
          {% set nav_role = (nav_user.get('role') or '').lower() %}

          <a href="{{ url_for('home') }}"
             class="{% if request.endpoint == 'home' %}active{% endif %}">
             Dashboard
          </a>

          <a href="{{ url_for('sales.sales_home') }}"
             class="{% if request.blueprint == 'sales' %}active{% endif %}">
             Sales
          </a>

          <a href="{{ url_for('inventory.inventory_home') }}"
             class="{% if request.blueprint == 'inventory' %}active{% endif %}">
             Inventory
          </a>

          <a href="{{ url_for('reports.reports_home') }}"
             class="{% if request.blueprint == 'reports' %}active{% endif %}">
             Reports
          </a>

          <a href="{{ url_for('invoices.list_invoices') }}"
             class="{% if request.blueprint == 'invoices' %}active{% endif %}">
             Invoices
          </a>

          {% if nav_role == 'admin' or nav_user.get('is_platform_admin') %}
            <a href="{{ url_for('admin.team_management') }}"
               class="{% if request.endpoint == 'admin.team_management' %}active{% endif %}">
               Team
            </a>
          {% endif %}

          <!-- Financial (Feature Controlled) -->
          {% set can_access_financial = has_feature_access('financial') %}

          <a href="{{ url_for('financial.financial_home') }}"
             class="{% if request.blueprint == 'financial' %}active{% endif %}
                    {% if not can_access_financial %}locked{% endif %}">
             Financial
             {% if not can_access_financial %}
                ðŸ”’
             {% endif %}
          </a>

          <!-- Admin (Only Platform Owner) -->
          {% if session.get('user', {}).get('is_platform_admin') %}
            <a href="{{ url_for('platform.dashboard') }}"
               class="{% if request.blueprint == 'platform' %}active{% endif %}">
               Platform
            </a>
          {% endif %}

        </div>

        <!-- User Info -->
        {% set user = session.get('user') %}
        <div class="userbox">
          {% if user %}
            <span class="pill">
              {{ user.get('name','User') }}
            </span>
            <form method="post" action="{{ url_for('auth.logout') }}" style="display:inline;">
              <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="pill" style="cursor:pointer; color:inherit;">
                Logout
              </button>
            </form>
          {% else %}
            <a class="pill" href="{{ url_for('auth.login') }}">
              Login
            </a>
          {% endif %}
        </div>

      </div>
      <!-- ===================== END NAVBAR ===================== -->


      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="flash {{ category }}">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Page Content -->
      {% block content %}{% endblock %}

    </div>
  </body>
</html>
